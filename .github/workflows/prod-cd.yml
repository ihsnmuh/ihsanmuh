name: Deploy App ğŸš€

on:
  workflow_run:
    workflows: ['Build App ğŸ› ï¸']
    types:
      - completed
    branches: ['master']

concurrency:
  group: production-deployment
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: Deploy using ssh
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.PRIVATE_KEY }}
          port: 22
          script: |
            set -e  # Exit on error

            echo "ğŸš€ Starting deployment process..."

            # Navigate to the application directory
            cd /var/www/fe-app/ihsanmuh/ || (echo "âŒ Directory not found!" && exit 1)

            # Store current commit for potential rollback
            CURRENT_COMMIT=$(git rev-parse HEAD)
            echo "ğŸ“Œ Current commit: $CURRENT_COMMIT"

            # Fetch and update the latest code from GitHub
            echo "ğŸ“¥ Fetching latest code from master branch..."
            git fetch --all
            git checkout master || (echo "âŒ Failed to checkout master!" && exit 1)
            git reset --hard origin/master || (echo "âŒ Failed to reset to origin/master!" && exit 1)

            NEW_COMMIT=$(git rev-parse HEAD)
            echo "âœ¨ New commit: $NEW_COMMIT"

            # Check if there are actual changes
            if [ "$CURRENT_COMMIT" = "$NEW_COMMIT" ]; then
              echo "â„¹ï¸ No new changes to deploy."
              exit 0
            fi

            # Load Node.js environment
            echo "âš™ï¸ Setting up Node.js environment..."
            export NVM_DIR=~/.nvm
            source ~/.nvm/nvm.sh
            nvm use 22 || (echo "âŒ nvm command failed. Ensure nvm is installed." && exit 1)

            # Enable corepack for Yarn Berry
            corepack enable

            # Install dependencies
            echo "ğŸ“¦ Installing dependencies..."
            yarn install --immutable || (echo "âŒ Failed to install dependencies using yarn!" && exit 1)

            # Build the application
            echo "ğŸ”¨ Building application..."
            yarn build || {
              echo "âŒ Application build failed! Rolling back..."
              git reset --hard $CURRENT_COMMIT
              exit 1
            }

            # Restart the application
            echo "ğŸ”„ Restarting application using PM2..."
            pm2 restart ihsanmuh-web || (echo "âŒ Failed to restart application using PM2!" && exit 1)

            echo "âœ… Deployment completed successfully."
            echo "ğŸ“Š Deployed commit: $NEW_COMMIT"

      - name: Deployment status
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… Deployment successful!"
          else
            echo "âŒ Deployment failed!"
          fi
